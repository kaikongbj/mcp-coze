# Coze Chat 工具增强功能说明

## 新增功能

### 1. 自动生成随机 user_id
- **功能**: 当用户没有提供 `user_id` 参数时，系统自动生成一个随机 UUID
- **优势**: 简化用户调用，无需手动提供 user_id
- **实现**: 使用 `uuid::Uuid::new_v4()` 生成符合标准的 UUID

### 2. 自动等待对话完成并返回结果
- **功能**: 当对话状态为 `in_progress` 或 `created` 时，自动等待完成并获取最终回复
- **等待机制**: 最多等待 30 次，每次间隔 2 秒（总共最多 60 秒）
- **智能返回**: 自动提取助手的回复内容并展示

## 使用示例

### 最简调用（自动生成 user_id）
```json
{
  "bot_id": "7409830408747073570",
  "message": "请详细介绍kVPAC IDE的功能和特点"
}
```

### 指定 user_id 调用
```json
{
  "bot_id": "7409830408747073570",
  "message": "请详细介绍kVPAC IDE的功能和特点",
  "user_id": "custom_user_123"
}
```

## 响应格式

### 成功完成的对话
```
user_id: a1b2c3d4-e5f6-7890-abcd-ef1234567890 (自动生成)
对话ID: 7536570509862731815
消息ID: 7536570509862764583
状态: completed

🤖 助手回复:
kVPAC IDE是一款专业的PLC编程开发环境...
```

### 等待超时的情况
```
user_id: a1b2c3d4-e5f6-7890-abcd-ef1234567890 (自动生成)
对话ID: 7536570509862731815
消息ID: 7536570509862764583
状态: in_progress

⏰ 等待超时或对话未完成，请稍后手动查询结果
```

## 技术实现

### 新增 API 端点
- `GET /v3/chat/retrieve` - 获取对话详情
- `GET /v3/chat/message/list` - 获取对话消息列表

### 新增 API 客户端方法
- `get_chat_detail(conversation_id, chat_id)` - 获取对话详情
- `get_chat_messages(conversation_id, chat_id)` - 获取对话消息

### 工具层增强
- 自动 user_id 生成逻辑
- 对话状态轮询机制
- 智能消息提取和展示

## 好处

1. **用户体验提升**: 无需手动提供 user_id，简化调用
2. **完整结果获取**: 自动等待并返回完整的对话结果
3. **智能状态管理**: 自动处理不同的对话状态
4. **向后兼容**: 仍支持用户手动指定 user_id

## 注意事项

- 最大等待时间为 60 秒，超时后需要手动查询
- 生成的 user_id 格式为标准 UUID v4
- 系统会明确显示 user_id 是自动生成还是用户提供
